From 8c87256eed3333a848b3f1b18e65cd0aee100e9b Mon Sep 17 00:00:00 2001
From: Jory Pratt <anarchy@gentoo.org>
Date: Thu, 23 Jan 2025 21:33:41 -0600
Subject: [PATCH] Update generation of rc.local to ensure it will be before
 dvswitch if it is  installed

Signed-off-by: Jory Pratt <anarchy@gentoo.org>
---
 asl3_sayip_reboot_halt.sh | 102 ++++++++++++++++++--------------------
 1 file changed, 47 insertions(+), 55 deletions(-)
 mode change 100644 => 100755 asl3_sayip_reboot_halt.sh

diff --git a/asl3_sayip_reboot_halt.sh b/asl3_sayip_reboot_halt.sh
old mode 100644
new mode 100755
index b4e66ef..60c0e00
--- a/asl3_sayip_reboot_halt.sh
+++ b/asl3_sayip_reboot_halt.sh
@@ -1,118 +1,110 @@
-#!/bin/sh
+#!/bin/sh -e
 
 # This script installs all needed files for sayip/saypublicip/halt/reboot
-# It will also create and or modify /etc/rc.local so ip is announced upon
-# the system booting.
+# It will also create and modify /etc/rc.local so the IP is announced
+# upon system boot.
 # Copyright (C) 2024 Jory A. Pratt - W5GLE
-#
-# This program is free software; you can redistribute it and/or
-# modify it under the terms of the GNU General Public License
-# as published by the Free Software Foundation; either version 2
-# of the License, or (at your option) any later version.
-#
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-#
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
+# Released under the GNU General Public License v2 or later.
 
+# Ensure the script is run as root
 if [ "$(id -u)" -ne 0 ]; then
     echo "This script must be run as root or with sudo"
     exit 1
 fi
 
+# Validate input arguments
 if [ "$#" -ne 1 ]; then
     echo "Usage: $0 <NodeNumber>"
     exit 1
 fi
 
 NODE_NUMBER=$1
-
 CONF_FILE="/etc/asterisk/rpt.conf"
 BASE_URL="https://dev.gentoo.org/~anarchy/asl3-scripts"
 TARGET_DIR="/etc/asterisk/local"
 FILES_TO_DOWNLOAD="halt.sh reboot.sh sayip.sh saypublicip.sh speaktext.sh halt.ulaw reboot.ulaw ip-address.ulaw public-ip-address.ulaw"
 
-if [ ! -d "$TARGET_DIR" ]; then
-    mkdir -p "$TARGET_DIR" || {
-        echo "Failed to create directory $TARGET_DIR"
-        exit 1
-    }
-fi
+# Create target directory if it doesn't exist
+mkdir -p "$TARGET_DIR" || {
+    echo "Failed to create directory $TARGET_DIR"
+    exit 1
+}
 
+# Download required files
 cd "$TARGET_DIR" || {
     echo "Failed to change directory to $TARGET_DIR"
     exit 1
 }
 
 for FILE in $FILES_TO_DOWNLOAD; do
-    curl -O "$BASE_URL/$FILE" > /dev/null 2>&1 || {
+    if ! curl -s -O "$BASE_URL/$FILE"; then
         echo "Failed to download $FILE"
         exit 1
-    }
+    fi
 done
 
-chmod +x *.sh
-
-chown root:asterisk *.sh *.ulaw 2>/dev/null || echo "Unable to set ownership (run as root for this step)"
+# Set permissions for the downloaded files
 chmod 750 *.sh
 chmod 640 *.ulaw
+chown root:asterisk *.sh *.ulaw 2>/dev/null || echo "Unable to set ownership (run as root for this step)"
 
+# Create the environment configuration file
 cat <<EOF > /etc/asterisk/local/allstar.env
 #!/bin/sh
 
-# defines the primary node (node) number
+# Defines the primary node (node) number
 export NODE=$NODE_NUMBER
 
-# Defines saying of local IP address at boot (enabled or disabled)
-# Default: "enabled"
+# Enable saying the local IP address at boot
 export SAY_IP_AT_BOOT="enabled"
 EOF
 
 chown root:root /etc/asterisk/local/allstar.env
 chmod 755 /etc/asterisk/local/allstar.env
 
-CONTENT="
-# Source the allstar variables
+# Ensure /etc/rc.local exists and starts with the shebang
+if [ ! -f /etc/rc.local ]; then
+    echo "#!/bin/sh -e" > /etc/rc.local
+    chmod +x /etc/rc.local
+fi
+
+# Add content to /etc/rc.local directly after the shebang
+if ! grep -q "Source the AllStar variables" /etc/rc.local; then
+    if ! head -n 1 /etc/rc.local | grep -q "^#!/bin/sh -e"; then
+        sed -i "1i#!/bin/sh -e" /etc/rc.local
+    fi
+
+    # Use a here document to safely append multi-line content
+    temp_content=$(mktemp)
+    cat <<'RCLOCAL' > "$temp_content"
+# Source the AllStar variables
 if [ -f /etc/asterisk/local/allstar.env ]; then
     . /etc/asterisk/local/allstar.env
 else
-    echo \"Unable to read /etc/asterisk/local/allstar.env file.\"
-    echo \"Asterisk will not start.\"
+    echo "Unable to read /etc/asterisk/local/allstar.env file."
+    echo "Asterisk will not start."
     exit 1
 fi
 
-if [ \"\$(echo \"\${SAY_IP_AT_BOOT}\" | tr \"[:upper:]\" \"[:lower:]\")\" = \"enabled\" ]; then
+if [ "$(echo "${SAY_IP_AT_BOOT}" | tr "[:upper:]" "[:lower:]")" = "enabled" ]; then
     sleep 12
-    /etc/asterisk/local/sayip.sh \"\$NODE\"
+    /etc/asterisk/local/sayip.sh "$NODE"
 fi
-"
 
-if [ -f /etc/rc.local ]; then
-    if ! head -n 1 /etc/rc.local | grep -q "^#!/bin/sh"; then
-        { echo "#!/bin/sh"; cat /etc/rc.local; } > /tmp/rc.local.tmp
-        mv /tmp/rc.local.tmp /etc/rc.local
-    fi
-    if ! grep -q "Source the allstar variables" /etc/rc.local; then
-        printf "%s\n" "$CONTENT" >> /etc/rc.local
-    fi
-else
-    {
-        echo "#!/bin/sh"
-        printf "%s\n" "$CONTENT"
-    } > /etc/rc.local
-    chmod +x /etc/rc.local
+RCLOCAL
+
+    # Insert the content directly after the shebang
+    sed -i "2r $temp_content" /etc/rc.local
+    rm "$temp_content"
 fi
 
+# Backup and modify the configuration file
 cp "$CONF_FILE" "${CONF_FILE}.bak"
-sed -i "/\\[functions\\]/a \\
+sed -i "/\[functions\]/a \\
 A1 = cmd,/etc/asterisk/local/sayip.sh $NODE_NUMBER \\
 A3 = cmd,/etc/asterisk/local/saypublicip.sh $NODE_NUMBER \\
 B1 = cmd,/etc/asterisk/local/halt.sh $NODE_NUMBER \\
 B3 = cmd,/etc/asterisk/local/reboot.sh $NODE_NUMBER \\
 " "$CONF_FILE"
 
-echo "ASL3 now has support for sayip/reboot/halt configured for node $NODE_NUMBER..."
+echo "ASL3 support for sayip/reboot/halt is configured for node $NODE_NUMBER."
-- 
2.45.3

